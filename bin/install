#!/usr/bin/env bash

RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
NOCOLOR="\e[0m"

# HELP #
display_usage() {
    echo "\
Usage:
  run [command]
HELP
  help              h       show list of commands
INSTALLING COMMAND
  list              ls
  <script>          install specific script from '$INSTALL_DIR' directory";
}

####################
### AUTOCOMPLETE ###
####################

# https://askubuntu.com/questions/68175/how-to-create-script-with-auto-complete
_load()
{
  _script_commands=$(bin/install _shortlist)
  local cur
  COMPREPLY=()
  cur="${COMP_WORDS[COMP_CWORD]}"
  COMPREPLY=( $(compgen -W "${_script_commands}" -- ${cur}) )
}
complete -o nospace -F _load bin/install

###############
### INSTALL ###
###############

INSTALL_DIR=".recipes"

INSTALL_SCRIPTS=$(find ${INSTALL_DIR} -type f | sort | sed -e 's~.recipes/~~' | tr "\n" " ")
INSTALL_SCRIPTS_SHOW=$(find ${INSTALL_DIR} -type f | sort | sed -e 's~.recipes/~~')

if [[ -z "$@" ]]; then
    echo "Empty installation option."
fi

for i in "$@"; do
    case $i in
        # list
        list|ls)
            echo -e "\n*** List of available scripts in '${YELLOW}$INSTALL_DIR${NOCOLOR}' directory ***"
            echo -e "${BLUE}$INSTALL_SCRIPTS_SHOW${NOCOLOR}"
            echo ""
        ;;
        # autocompletion
        _shortlist)
            echo $(bin/install ls | tail -n +3)
        ;;
        # help
        help|h|--help)
            display_usage
        ;;
        # default
        *)
            for script in ${INSTALL_SCRIPTS[@]}; do
                if [[ "$@" == "$script" ]]; then
                    echo "Installing '$script'"
                    sh -c "bash $INSTALL_DIR/$script"
                fi
            done
            echo "'$@' not found."
        ;;
    esac
done
