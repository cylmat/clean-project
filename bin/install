#!/usr/bin/env bash

# Function to display help
function show_help() {
  echo "üõà Usage: $0 <recipe> <container_name> --project_name=<project_name>"
  echo
  echo "Install 'recipe' in 'container_name'."
  echo "Example: $0 express node_container"
}

# Check if the argument is provided
if [ -z "$1" ]; then
  echo "‚ùå Error: No recipe provided."
  echo
  show_help
  exit 1
elif [ -z "$2" ]; then
  echo "‚ùå Error: No container name provided."
  echo
  show_help
  exit 1
fi

# Check if the user asked for help
if [[ "$1" == "--help" || "$1" == "-h" || "$1" == "help" ]]; then
  show_help
  exit 0
fi

if [[ "$3" == --project-name=* ]]; then
  PROJECT_NAME="${3#--project-name=}"
fi

if [[ -z "$UID" || -z "$GID" ]]; then 
  echo "Please run:"
  echo "export UID=\$(id -u)";
  echo "export GID=\$(id -g)";
  exit 1
fi

RECIPE=$1
CONTAINER=$2
RECIPE_PATH=$(find .recipes -type f -name "${RECIPE}")
BASEPATH=$(echo "${RECIPE_PATH}" | rev | cut -d/ -f2- | rev)

function install_user() {
  if [[ -z "${UID}" ]]; then echo "Please run export UID=\$(id -u)"; fi
  if [[ -z "${GID}" ]]; then echo "Please run export GID=\$(id -g)"; fi

	docker exec -u root ${CONTAINER} sh -c "addgroup user --gid ${GID}"
	docker exec -u root ${CONTAINER} sh -c "adduser user --uid ${UID} --gid ${GID} --gecos GECOS --disabled-password"
}

function install_recipe() {
  if [ -z "${RECIPE_PATH}" ]; then echo "‚ùå Error: No recipe named '${RECIPE}' found."; fi

  install_user
	docker exec ${CONTAINER} sh -c "mkdir -m 755 -p /tmp/${BASEPATH}"
	docker cp ${RECIPE_PATH} ${CONTAINER}:/tmp/${BASEPATH}/${RECIPE}

  CMD="/tmp/${BASEPATH}/${RECIPE}"
  if [ -n "$PROJECT_NAME" ]; then CMD="$CMD --project-name=$PROJECT_NAME"; fi
	docker exec ${CONTAINER} sh -c "$CMD"
}

install_recipe
